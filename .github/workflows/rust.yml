name: Rust CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the code from the repository
      - uses: actions/checkout@v4

      # Step 2: Set the DATABASE_URL environment variable
      - name: Set DATABASE_URL
        run: echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV

      # Step 3: Install SQLx CLI for managing the database
      - name: Install SQLx CLI
        run: cargo install sqlx-cli

      # Step 4: Build the project
      - name: Build
        run: cargo build --verbose

      # Step 5: Run database migrations (if needed)
      - name: Run database migrations
        run: |
          sqlx migrate run

      # Step 6: Start the API server in the background
      - name: Run API server in background
        run: |
          cargo run --release &
          echo "Waiting for the API to be ready on port 8080..."
          # Attendre que le port 8080 soit ouvert
          for i in {1..30}; do
            nc -z localhost 8080 && echo "API is ready" && break
            echo "Waiting for API..." && sleep 1
          done

      # Step 7: Run the tests
      - name: Run tests
        run: cargo test --verbose
        env:
          API_URL: http://localhost
          API_PORT: 8080
